#include <ncurses.h>
#include <stdbool.h>
#include <assert.h>


const int TOUCHE_FIN_PARTIE = KEY_DC;


/*
Précondition:
    (x) est un entier naturel
    (y) est un entier naturel
*/
void changerCaractere(int x, int y, char caractere){
    //précondition
    assert(x>=0 && y>=0);

    //La fonction mvaddch de ncurses prend la valeur en ordonnée en 1er argument et la valeur en abscisse en 2eme
    mvaddch(y, x, caractere);
}


//Appelle la fonction refresh de ncurses qui raffrachît les caractères affichés sur l'écran
void rafraichirEcran(){
    refresh();
}


void initFenetre(){
    //Initialise la fênetre ncurses
    initscr();

    //Indique au clavier que relacher une touche n'est pas la même action que l'appuyer
    noecho();

    //Masque le curseur en jeu
    curs_set(0);

    //Indique à ncurses de ne pas attendre, lors de l'appel de la fonction (getch), qu'une touche soit appuyée
    nodelay(stdscr,true);

    //Indique à ncurses que toutes les touches du clavier peuvent être enfoncées lors du jeu
    keypad(stdscr, true);
}


/*
Préconditions:
    (max_x) est un entier naturel
    (max_y) est un entier naturel
*/
void affiche(int grille[30][100], const char BLOC_CARACTERE[], int max_x, int max_y){
    //precondition
    assert(max_x >= 0 && max_y >= 0);

    for(int y=0 ; y<max_y ; y++){
        for(int x=0 ; x<max_x ; x++){
			changerCaractere(x, y, BLOC_CARACTERE[grille[y][x]]);
		}
	}
}


void finFenetre(){
    //Ferme la fênetre de ncurses
    endwin();
}


bool isToucheAppuyee(){
    //getch renvoit une valeur lorsque une touche vient d'être enfoncée
    return getch()!=ERR;
}


void effacer(){
    clear();
}


bool relancerPartie(){
    //Affiche le message de fin de partie
    mvprintw(13, 30, " Game Over! ");
    mvprintw(14, 30, " Appuyez sur une touche pour relancer ");
    mvprintw(15, 30, " Ou appuyez sur 'suppr' pour quitter ");
    rafraichirEcran();

    //On attend que le joueur appuie sur une touche
    nodelay(stdscr,false);
    int toucheAppuyee = getch();

    //On réactive le mode nodelay pour la partie suivante
    nodelay(stdscr,true);

    //Si la touche appuyee n'est pas celle de fin de partie, c'est à dire qu'on va relancer une partie, on renvoit true
    return toucheAppuyee != TOUCHE_FIN_PARTIE;
}
